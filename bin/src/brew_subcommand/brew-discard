#!/bin/bash

set -eu

PROG_NAME=$(basename "$0")

cask=false

main() {
  parse_options "$@"

  . $HOME/.dotpath

  if [ "$DOTPATH" = "" ]; then
    echo "The env DOTPATH is missing" >&2
    exit 2
  fi

  if $cask; then
    brew uninstall --cask "$argv"
  else
    brew uninstall "$argv"
  fi

  # Force update Brewfile by current Mac's installed packages
  brew bundle dump --force --file="$DOTPATH/core/Brewfile"
  # Delete existing Brewfile.lock.json to clean up
  rm "$DOTPATH/core/Brewfile.lock.json"
  # Update Brewfile.lock.json
  brew bundle install --no-upgrade --file="$DOTPATH/core/Brewfile"

  echo "Uninstalled $argv successfully! Do not forget to add and commit changes."
}

parse_options() {
  for opt in "$@"
  do
    case "$opt" in
      '--cask')
        shift 1
        cask=true
      ;;
      '--' | '-')
        shift 1
        param+=( "$@" )
        break
      ;;
      -*)
        echo "$PROG_NAME: illegal option -- '$(echo $1 | sed 's/^-*//')'" 1>&2
        exit 1
      ;;
      *)
        if [[ -n "$1" ]] && [[ ! "$1" =~ ^-+ ]]; then
          argv+=( "$1" )
          shift 1
        fi
      ;;
    esac
  done
}

main "$@"
